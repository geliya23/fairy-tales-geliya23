<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¥è¯æ•…äº‹é›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=EB+Garamond:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            font-family: 'EB Garamond', serif;
            background-color: #fdf6e3;
            background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/old_mathematics.png');
            background-attachment: fixed;
            overflow: hidden;
        }

        .main-title {
            font-family: 'Cinzel Decorative', serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .story-list-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.75rem;
            text-align: center;
        }

        #story-list-container {
            background-color: rgba(245, 245, 220, 0.5);
            backdrop-filter: blur(4px);
            border-right: 1px solid rgba(139, 69, 19, 0.2);
        }

        .story-list-item {
            border-radius: 8px;
            font-size: 1.1rem;
            color: #5d4037;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .story-list-item:hover {
            background-color: rgba(218, 165, 32, 0.2);
            transform: translateX(5px);
            border-color: rgba(218, 165, 32, 0.4);
        }

        .story-list-item.active {
            background-color: rgba(218, 165, 32, 0.4);
            color: #4e342e;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #story-content-wrapper {
            background: rgba(253, 246, 227, 0.85);
            backdrop-filter: blur(4px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: calc(100vh - 10rem);
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.5);
        }

        #story-content {
            transition: opacity 0.4s ease-in-out;
        }

        #story-content-wrapper::-webkit-scrollbar {
            width: 10px;
        }
        #story-content-wrapper::-webkit-scrollbar-track {
            background: rgba(188, 170, 164, 0.2);
            border-radius: 5px;
        }
        #story-content-wrapper::-webkit-scrollbar-thumb {
            background-color: rgba(139, 69, 19, 0.4);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #story-content-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: rgba(139, 69, 19, 0.6);
        }

        .story-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 1px dashed rgba(139, 69, 19, 0.3);
            padding-bottom: 1rem;
        }
        .story-title {
            font-family: 'EB Garamond', serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: #5d4037;
        }
        .story-subtitle {
            font-size: 1.1rem;
            color: #8d6e63;
            font-style: italic;
            margin-top: 0.5rem;
        }
        .story-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .story-group {
            border-radius: 8px;
            overflow: hidden;
        }

        .story-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background-color: rgba(218, 165, 32, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .story-group-header:hover {
            background-color: rgba(218, 165, 32, 0.25);
        }

        .story-group-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #5d4037;
            font-size: 1.1rem;
        }

        .story-group-count {
            font-size: 0.875rem;
            color: #8d6e63;
            background-color: rgba(139, 69, 19, 0.1);
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
        }

        .story-group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: rgba(255, 255, 255, 0.3);
        }

        .story-group.expanded .story-group-content {
            max-height: 1000px;
            transition: max-height 0.3s ease-in;
        }

        .story-group-list {
            padding: 0.5rem;
            display: grid;
            gap: 0.25rem;
        }

        .story-group-list .story-list-item {
            margin: 0;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        .story-group.expanded .chevron {
            transform: rotate(180deg);
        }

        .loading-spinner {
            border: 3px solid rgba(218, 165, 32, 0.3);
            border-top: 3px solid rgba(218, 165, 32, 1);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #fcc;
            margin: 1rem 0;
        }

        .search-highlight {
            background-color: rgba(255, 235, 59, 0.4);
            font-weight: bold;
        }
    </style>
</head>
<body class="text-stone-800">
    <div class="flex flex-col h-screen">
        <header class="text-center py-6 px-8 z-10 relative">
            <h1 class="main-title text-5xl md:text-6xl font-bold text-stone-800/90">æˆ‘çš„ç«¥è¯æ•…äº‹é›†</h1>
            <p class="text-stone-600 mt-2">ç²¾é€‰ç«¥è¯æ•…äº‹ï¼Œå¸¦æ‚¨è¿›å…¥å¥‡å¹»ä¸–ç•Œ</p>
        </header>

        <div class="flex flex-1 overflow-hidden px-4 pb-4 md:px-8 md:pb-8">
            <aside id="story-list-container" class="w-1/3 p-6 overflow-y-auto rounded-l-lg">
                <h2 class="story-list-title text-stone-700 mb-6">æ•…äº‹åˆ—è¡¨</h2>

                <div class="mb-4">
                    <input type="text" id="story-search" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 text-sm" placeholder="ğŸ” æœç´¢æ•…äº‹...">
                </div>

                <div id="story-groups-container" class="space-y-4">
                    <div id="loading-indicator" class="text-center">
                        <div class="loading-spinner"></div>
                        <p class="text-stone-600 mt-2">æ­£åœ¨åŠ è½½æ•…äº‹...</p>
                    </div>
                </div>
            </aside>

            <main class="w-2/3" id="story-main-content">
                 <div id="story-content-wrapper" class="p-8 md:p-12">
                    <div id="story-content">
                        <div class="flex items-center justify-center h-full">
                            <p class="text-2xl text-gray-500">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•…äº‹æ¥é˜…è¯»</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ============ Supabase é…ç½® ============
        const SUPABASE_URL = 'https://vvuqvvfwrmjsyybmptgd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2dXF2dmZ3cm1qc3l5Ym1wdGdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTA4MjYsImV4cCI6MjA3NzU4NjgyNn0.sOyVSYOKjmZVo-thtu5ESnQ6OZC0-xuCLA4edn5FPeY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============ å…¨å±€å˜é‡ ============
        let allStories = [];
        let currentStory = null;

        // ============ å·¥å…·å‡½æ•° ============

        // åŠ è½½æ•…äº‹åˆ—è¡¨
        async function loadStoriesList() {
            try {
                const { data, error } = await supabase
                    .from('stories')
                    .select('id, title, filename')
                    .order('id', { ascending: true });

                if (error) {
                    console.error('ä»SupabaseåŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥:', error.message);
                    throw error;
                }

                allStories = data.map(story => ({
                    title: story.title,
                    file: story.filename,
                    id: story.id
                }));

                console.log(`âœ… æˆåŠŸåŠ è½½ ${allStories.length} ä¸ªæ•…äº‹`);
                return allStories;
            } catch (error) {
                console.error('åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥:', error);
                // é™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                return await loadStoriesFromLocal();
            }
        }

        // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        async function loadStoriesFromLocal() {
            try {
                const response = await fetch('stories.json');
                allStories = await response.json();
                console.log(`âœ… ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ ${allStories.length} ä¸ªæ•…äº‹`);
                return allStories;
            } catch (error) {
                console.error('æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½æ•…äº‹å†…å®¹
        async function loadStoryContent(fileName) {
            try {
                const { data, error } = await supabase
                    .from('stories')
                    .select('content')
                    .eq('filename', fileName)
                    .single();

                if (error) {
                    console.error('ä»SupabaseåŠ è½½æ•…äº‹å†…å®¹å¤±è´¥:', error.message);
                    // é™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                    const response = await fetch(`story/${fileName}`);
                    return await response.text();
                }

                return data.content;
            } catch (error) {
                console.error('åŠ è½½æ•…äº‹å†…å®¹å¤±è´¥:', error);
                // é™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                const response = await fetch(`story/${fileName}`);
                return await response.text();
            }
        }

        // è§£ææ•…äº‹å†…å®¹
        function parseStoryContent(content) {
            const lines = content.trim().split('\n');
            const title = lines[0]?.replace(/^#\s*/, '') || 'æ— æ ‡é¢˜';
            const subtitle = lines[1]?.replace(/^##\s*/, '') || '';
            const body = lines.slice(2).join('\n').trim();

            return { title, subtitle, body };
        }

        // æ¸²æŸ“æ•…äº‹
        function renderStory(story) {
            const contentDiv = document.getElementById('story-content');
            contentDiv.style.opacity = '0';

            setTimeout(() => {
                contentDiv.innerHTML = `
                    <div class="story-header">
                        <h1 class="story-title">${story.title}</h1>
                        ${story.subtitle ? `<p class="story-subtitle">${story.subtitle}</p>` : ''}
                    </div>
                    <div class="story-body">
                        ${marked.parse(story.body)}
                    </div>
                `;
                contentDiv.style.opacity = '1';
            }, 200);
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
        function renderStoryList(stories) {
            const container = document.getElementById('story-groups-container');
            container.innerHTML = '';

            // æŒ‰æ–‡ä»¶ååˆ†ç»„
            const groups = {};
            stories.forEach(story => {
                const letter = story.file.charAt(0).toUpperCase();
                if (!groups[letter]) {
                    groups[letter] = [];
                }
                groups[letter].push(story);
            });

            // æ¸²æŸ“æ¯ä¸ªåˆ†ç»„
            Object.keys(groups).sort().forEach(letter => {
                const groupStories = groups[letter];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'story-group';

                groupDiv.innerHTML = `
                    <div class="story-group-header" onclick="toggleGroup(this)">
                        <div class="story-group-title">
                            <span class="chevron">â–¼</span>
                            <span>å­—æ¯ ${letter}</span>
                        </div>
                        <span class="story-group-count">${groupStories.length}</span>
                        </div>
                    <div class="story-group-content">
                        <div class="story-group-list">
                            ${groupStories.map(story => `
                                <div class="story-list-item p-2 cursor-pointer" onclick="selectStory('${story.file}')">
                                    ${highlightSearchTerm(story.title)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                container.appendChild(groupDiv);
            });
        }

        // åˆ‡æ¢åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleGroup(header) {
            const group = header.parentElement;
            group.classList.toggle('expanded');
        }

        // é«˜äº®æœç´¢è¯
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('story-search').value.trim();
            if (!searchTerm) return text;

            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // é€‰æ‹©æ•…äº‹
        async function selectStory(fileName) {
            if (currentStory === fileName) return;

            // æ›´æ–°æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.story-list-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            currentStory = fileName;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('story-content').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="loading-spinner"></div>
                </div>
            `;

            try {
                const content = await loadStoryContent(fileName);
                const story = parseStoryContent(content);
                renderStory(story);
            } catch (error) {
                document.getElementById('story-content').innerHTML = `
                    <div class="error-message">
                        <strong>åŠ è½½æ•…äº‹å¤±è´¥</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // æœç´¢æ•…äº‹
        function searchStories(term) {
            const filteredStories = term.trim() === '' ?
                allStories :
                allStories.filter(story =>
                    story.title.toLowerCase().includes(term.toLowerCase())
                );

            renderStoryList(filteredStories);
        }

        // åˆå§‹åŒ–
        async function initialize() {
            try {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                document.getElementById('loading-indicator').style.display = 'none';

                // åŠ è½½æ•…äº‹åˆ—è¡¨
                await loadStoriesList();

                // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
                renderStoryList(allStories);

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('story-groups-container').innerHTML = `
                    <div class="error-message">
                        <strong>åŠ è½½æ•…äº‹å¤±è´¥</strong>
                        <p>${error.message}</p>
                        <p class="mt-2 text-sm">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', () => {
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('story-search').addEventListener('input', (e) => {
                searchStories(e.target.value);
            });

            // åˆå§‹åŒ–åº”ç”¨
            initialize();
        });
    </script>
</body>
</html>
