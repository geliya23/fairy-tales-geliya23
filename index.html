<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¥è¯æ•…äº‹é›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=EB+Garamond:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            font-family: 'EB Garamond', serif;
            background-color: #fdf6e3; /* A soft, parchment-like color */
            background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/old_mathematics.png');
            background-attachment: fixed;
            overflow: hidden;
        }

        .main-title {
            font-family: 'Cinzel Decorative', serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .story-list-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.75rem;
            text-align: center;
        }

        #story-list-container {
            background-color: rgba(245, 245, 220, 0.5); /* Semi-transparent beige */
            backdrop-filter: blur(4px);
            border-right: 1px solid rgba(139, 69, 19, 0.2); /* Faint brown border */
        }

        .story-list-item {
            border-radius: 8px;
            font-size: 1.1rem;
            color: #5d4037; /* A deep brown */
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .story-list-item:hover {
            background-color: rgba(218, 165, 32, 0.2); /* Faint goldenrod */
            transform: translateX(5px);
            border-color: rgba(218, 165, 32, 0.4);
        }

        .story-list-item.active {
            background-color: rgba(218, 165, 32, 0.4); /* Goldenrod */
            color: #4e342e;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #story-content-wrapper {
            background: rgba(253, 246, 227, 0.85); /* Slightly more opaque parchment */
            backdrop-filter: blur(4px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: calc(100vh - 10rem);
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.5);
        }

        #story-content {
            transition: opacity 0.4s ease-in-out;
        }

        /* Custom scrollbar for a more thematic feel */
        #story-content-wrapper::-webkit-scrollbar {
            width: 10px;
        }
        #story-content-wrapper::-webkit-scrollbar-track {
            background: rgba(188, 170, 164, 0.2);
            border-radius: 5px;
        }
        #story-content-wrapper::-webkit-scrollbar-thumb {
            background-color: rgba(139, 69, 19, 0.4); /* SaddleBrown, semi-transparent */
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #story-content-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: rgba(139, 69, 19, 0.6);
        }

        /* Styles for the content loaded from story files */
        .story-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 1px dashed rgba(139, 69, 19, 0.3);
            padding-bottom: 1rem;
        }
        .story-title {
            font-family: 'EB Garamond', serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: #5d4037;
        }
        .story-subtitle {
            font-size: 1.1rem;
            color: #8d6e63;
            font-style: italic;
            margin-top: 0.5rem;
        }
        .story-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }

    </style>
</head>
<body class="text-stone-800">

    <div class="flex flex-col h-screen">
        <header class="text-center py-6 px-8 z-10 relative">
            <h1 class="main-title text-5xl md:text-6xl font-bold text-stone-800/90">æˆ‘çš„ç«¥è¯æ•…äº‹é›†</h1>
            <div class="absolute top-1/2 right-8 -translate-y-1/2 flex gap-3">
                <button id="github-settings-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow-md transition-all duration-200 font-medium">
                    â˜ï¸ äº‘å­˜å‚¨è®¾ç½®
                </button>
                <button id="ai-generate-btn" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg shadow-md transition-all duration-200 font-medium">
                    ğŸ¤– AI ç”Ÿæˆæ•…äº‹
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden px-4 pb-4 md:px-8 md:pb-8">
            <aside id="story-list-container" class="w-1/3 p-6 overflow-y-auto rounded-l-lg">
                <h2 class="story-list-title text-stone-700 mb-6">æ•…äº‹åˆ—è¡¨</h2>
                <ul id="story-list" class="space-y-3">
                    <!-- Story list generated by JS -->
                </ul>
            </aside>

            <main class="w-2/3" id="story-main-content">
                 <div id="story-content-wrapper" class="p-8 md:p-12">
                    <div id="story-content">
                        <div class="flex items-center justify-center h-full">
                            <p class="text-2xl text-gray-500">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•…äº‹æ¥é˜…è¯»</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- AI ç”Ÿæˆæ•…äº‹æ¨¡æ€æ¡† -->
    <div id="ai-generate-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl mx-4 p-6 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-stone-800">AI ç”Ÿæˆæ•…äº‹</h2>
                <button id="close-generate-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="flex space-x-4 flex-1 overflow-hidden">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                <div class="w-1/3 flex flex-col space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-2">æ•…äº‹ä¸»é¢˜/æç¤ºè¯</label>
                        <textarea id="story-prompt" rows="6" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="ä¾‹å¦‚ï¼šä¸€åªå°å…”å­åœ¨æ£®æ—é‡Œçš„å†’é™©..."></textarea>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="prompt-template text-xs px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded" data-prompt="ä¸€åªå°å…”å­åœ¨æ£®æ—é‡Œçš„å†’é™©ï¼Œå®ƒé‡åˆ°äº†ä¸€åªå‹å–„çš„è€çŒ«å¤´é¹°å­¦ä¼šäº†å‹‡æ•¢">ğŸ° å°åŠ¨ç‰©å†’é™©</button>
                            <button class="prompt-template text-xs px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded" data-prompt="ä¸€ä¸ªç¥å¥‡çš„é­”æ³•èŠ±å›­ï¼Œé‡Œé¢æœ‰ä¼šè¯´è¯çš„æ¤ç‰©å’Œå‹å–„çš„å°ç²¾çµ">ğŸŒ¸ é­”æ³•ä¸–ç•Œ</button>
                            <button class="prompt-template text-xs px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded" data-prompt="ä¸€åªå°é¸Ÿå­¦ä¼šäº†é£ç¿”ï¼Œå®ƒå¸®åŠ©å…¶ä»–å°åŠ¨ç‰©è§£å†³äº†å›°éš¾ï¼Œæ˜ç™½äº†å‹è°Šçš„çè´µ">ğŸ¦ å‹è°Šä¸æˆé•¿</button>
                            <button class="prompt-template text-xs px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded" data-prompt="åœ¨ä¸€ä¸ªå¤è€çš„åŸå ¡é‡Œï¼Œä½ç€ä¸€ä½å–„è‰¯çš„å°å…¬ä¸»ï¼Œå¥¹ç”¨æ™ºæ…§åŒ–è§£äº†ä¸€åœºå±æœº">ğŸ‘¸ å…¬ä¸»æ•…äº‹</button>
                            <button class="prompt-template text-xs px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded" data-prompt="ä¸€æ¡å°é±¼æ¸¸å‘å¤§æµ·æ·±å¤„ï¼Œé‡åˆ°å„ç§æµ·æ´‹ç”Ÿç‰©ï¼Œå­¦ä¼šäº†åšæŒä¸æ‡ˆ">ğŸŸ æµ·æ´‹å†’é™©</button>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-stone-700">é€‰æ‹©æ¨¡å‹</label>
                            <button id="refresh-models-btn" class="text-xs text-amber-600 hover:text-amber-700">ğŸ”„ åˆ·æ–°</button>
                        </div>
                        <select id="model-select" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="">è¯·å…ˆé…ç½® API</option>
                        </select>
                    </div>

                    <button id="generate-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                        âœ¨ ç”Ÿæˆæ•…äº‹
                    </button>

                    <div class="text-xs text-gray-500 space-y-1">
                        <p><strong>æç¤ºï¼š</strong></p>
                        <p>â€¢ æè¿°å…·ä½“çš„æ•…äº‹åœºæ™¯</p>
                        <p>â€¢ æŒ‡å®šä¸»è§’å’Œæ€§æ ¼</p>
                        <p>â€¢ è¯´æ˜æƒ³è¦çš„æƒ…èŠ‚å‘å±•</p>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
                <div class="w-2/3 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-stone-700">ç”Ÿæˆç»“æœ</label>
                        <div id="generation-status" class="hidden">
                            <span class="text-sm text-amber-600 animate-pulse">ç”Ÿæˆä¸­...</span>
                        </div>
                    </div>
                    <textarea id="story-result" rows="20" class="flex-1 w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="ç”Ÿæˆçš„æ•…äº‹å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                    <div class="flex space-x-3 mt-4">
                        <button id="save-story-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                            ğŸ’¾ ä¿å­˜æ•…äº‹
                        </button>
                        <button id="cancel-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="ai-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-stone-800">AI è®¾ç½®</h2>
                <button id="close-settings-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">API Base URL</label>
                    <input type="text" id="api-baseurl" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="https://api.openai.com">
                    <p class="text-xs text-gray-500 mt-1">æ”¯æŒ OpenAIã€OpenRouterã€Ollama ç­‰å…¼å®¹ API</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">API Key</label>
                    <input type="password" id="api-key" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="sk-...">
                    <p class="text-xs text-gray-500 mt-1">å¯†é’¥ä»…å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°</p>
                </div>
                <div class="flex space-x-3">
                    <button id="save-settings-btn" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">ä¿å­˜</button>
                    <button id="clear-settings-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">æ¸…é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub äº‘å­˜å‚¨è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="github-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-stone-800">GitHub äº‘å­˜å‚¨è®¾ç½®</h2>
                <button id="close-github-settings-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">GitHub ç”¨æˆ·å</label>
                    <input type="text" id="github-username" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="geliya23" value="geliya23">
                    <p class="text-xs text-gray-500 mt-1">ä½ çš„GitHubç”¨æˆ·å</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Personal Access Token</label>
                    <input type="password" id="github-token" class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_...">
                    <p class="text-xs text-gray-500 mt-1">
                        éœ€è¦ repo æƒé™
                        <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="text-blue-600 hover:underline">ç‚¹å‡»è·å–</a>
                    </p>
                </div>
                <div class="flex space-x-3">
                    <button id="save-github-settings-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">ä¿å­˜</button>
                    <button id="clear-github-settings-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md transition duration-200 font-medium">æ¸…é™¤</button>
                </div>
                <div id="github-status" class="text-sm text-gray-600 hidden">
                    <p>çŠ¶æ€æ£€æŸ¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toast æ¶ˆæ¯å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const storyListElement = document.getElementById('story-list');
            const storyContentElement = document.getElementById('story-content');

            // AI åŠŸèƒ½ç›¸å…³ DOM å…ƒç´ 
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const aiSettingsModal = document.getElementById('ai-settings-modal');
            const aiGenerateModal = document.getElementById('ai-generate-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const closeGenerateBtn = document.getElementById('close-generate-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const clearSettingsBtn = document.getElementById('clear-settings-btn');
            const apiBaseurlInput = document.getElementById('api-baseurl');
            const apiKeyInput = document.getElementById('api-key');
            const storyPromptInput = document.getElementById('story-prompt');
            const modelSelect = document.getElementById('model-select');
            const generateBtn = document.getElementById('generate-btn');
            const refreshModelsBtn = document.getElementById('refresh-models-btn');
            const storyResultTextarea = document.getElementById('story-result');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const generationStatus = document.getElementById('generation-status');

            // GitHub äº‘å­˜å‚¨ç›¸å…³ DOM å…ƒç´ 
            const githubSettingsBtn = document.getElementById('github-settings-btn');
            const githubSettingsModal = document.getElementById('github-settings-modal');
            const closeGithubSettingsBtn = document.getElementById('close-github-settings-btn');
            const saveGithubSettingsBtn = document.getElementById('save-github-settings-btn');
            const clearGithubSettingsBtn = document.getElementById('clear-github-settings-btn');
            const githubUsernameInput = document.getElementById('github-username');
            const githubTokenInput = document.getElementById('github-token');
            const githubStatusDiv = document.getElementById('github-status');

            // Toast é€šçŸ¥ç›¸å…³ DOM å…ƒç´ 
            const toastContainer = document.getElementById('toast-container');

            // æœ¬åœ°å­˜å‚¨ç®¡ç†
            const API_CONFIG_KEY = 'ai_story_api_config';
            const GITHUB_CONFIG_KEY = 'github_token_config';
            const SELECTED_MODEL_KEY = 'selected_model_id';

            function saveApiConfig(baseurl, apikey) {
                localStorage.setItem(API_CONFIG_KEY, JSON.stringify({ baseurl, apikey }));
            }

            function loadApiConfig() {
                const config = localStorage.getItem(API_CONFIG_KEY);
                if (config) {
                    try {
                        return JSON.parse(config);
                    } catch (e) {
                        console.error('è§£æ API é…ç½®å¤±è´¥:', e);
                        return null;
                    }
                }
                return null;
            }

            function clearApiConfig() {
                localStorage.removeItem(API_CONFIG_KEY);
                apiBaseurlInput.value = '';
                apiKeyInput.value = '';
                modelSelect.innerHTML = '<option value="">è¯·å…ˆé…ç½® API</option>';
            }

            // æ¨¡å‹é€‰æ‹©ç®¡ç†
            function saveSelectedModel(modelId) {
                localStorage.setItem(SELECTED_MODEL_KEY, modelId);
            }

            function getSelectedModel() {
                return localStorage.getItem(SELECTED_MODEL_KEY);
            }

            function restoreSelectedModel() {
                const savedModelId = getSelectedModel();
                if (savedModelId && modelSelect.querySelector(`option[value="${savedModelId}"]`)) {
                    modelSelect.value = savedModelId;
                }
            }

            // ============ GitHub API å®¢æˆ·ç«¯ ============

            class GitHubAPI {
                constructor(token, username) {
                    this.token = token;
                    this.username = username;
                    this.baseUrl = 'https://api.github.com';
                    this.repoName = 'fairy-tales-geliya23';
                }

                // ä¿å­˜Tokenåˆ°localStorage
                saveToken(token) {
                    localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify({ token, username: this.username }));
                }

                // ä»localStorageåŠ è½½Token
                static loadToken() {
                    const config = localStorage.getItem(GITHUB_CONFIG_KEY);
                    if (config) {
                        try {
                            return JSON.parse(config);
                        } catch (e) {
                            console.error('è§£æ GitHub Token å¤±è´¥:', e);
                            return null;
                        }
                    }
                    return null;
                }

                // æ¸…é™¤Token
                static clearToken() {
                    localStorage.removeItem(GITHUB_CONFIG_KEY);
                }

                // è·å–è¯·æ±‚å¤´
                getHeaders() {
                    return {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    };
                }

                // éªŒè¯Tokenæœ‰æ•ˆæ€§
                async validateToken() {
                    try {
                        const response = await fetch(`${this.baseUrl}/user`, {
                            headers: this.getHeaders()
                        });
                        return response.ok;
                    } catch (error) {
                        console.error('TokenéªŒè¯å¤±è´¥:', error);
                        return false;
                    }
                }

                // æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
                async checkRepository() {
                    try {
                        const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repoName}`, {
                            headers: this.getHeaders()
                        });
                        if (response.status === 404) {
                            return false;
                        }
                        if (!response.ok) {
                            throw new Error(`æ£€æŸ¥ä»“åº“å¤±è´¥: ${response.status}`);
                        }
                        return true;
                    } catch (error) {
                        console.error('æ£€æŸ¥ä»“åº“æ—¶å‡ºé”™:', error);
                        throw error;
                    }
                }

                // åˆ›å»ºä»“åº“
                async createRepository() {
                    try {
                        const response = await fetch(`${this.baseUrl}/user/repos`, {
                            method: 'POST',
                            headers: this.getHeaders(),
                            body: JSON.stringify({
                                name: this.repoName,
                                description: 'æˆ‘çš„ç«¥è¯æ•…äº‹é›† - è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†çš„æ•…äº‹ç½‘ç«™',
                                private: false,
                                has_issues: true,
                                has_projects: false,
                                has_wiki: false,
                                auto_init: false
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(`åˆ›å»ºä»“åº“å¤±è´¥: ${response.status} - ${error.message}`);
                        }

                        return await response.json();
                    } catch (error) {
                        console.error('åˆ›å»ºä»“åº“æ—¶å‡ºé”™:', error);
                        throw error;
                    }
                }

                // åˆå§‹åŒ–ä»“åº“åŸºç¡€æ–‡ä»¶
                async initializeRepository() {
                    try {
                        // åˆ›å»ºstories.json
                        const storiesContent = JSON.stringify([], null, 2);
                        await this.createOrUpdateFile('stories.json', storiesContent, 'åˆå§‹åŒ–æ•…äº‹åˆ—è¡¨');

                        // åˆ›å»ºstoryç›®å½•å ä½æ–‡ä»¶
                        const readmeContent = '# æ•…äº‹ç›®å½•\n\nè¿™é‡Œå­˜æ”¾æ‰€æœ‰çš„æ•…äº‹æ–‡ä»¶ã€‚';
                        await this.createOrUpdateFile('story/README.md', readmeContent, 'åˆå§‹åŒ–æ•…äº‹ç›®å½•');

                        return true;
                    } catch (error) {
                        console.error('åˆå§‹åŒ–ä»“åº“æ—¶å‡ºé”™:', error);
                        throw error;
                    }
                }

                // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶
                async createOrUpdateFile(path, content, message) {
                    try {
                        // å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                        let sha = null;
                        try {
                            const getResponse = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repoName}/contents/${path}`, {
                                headers: this.getHeaders()
                            });
                            if (getResponse.ok) {
                                const fileData = await getResponse.json();
                                sha = fileData.sha;
                            }
                        } catch (e) {
                            // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º
                        }

                        const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repoName}/contents/${path}`, {
                            method: 'PUT',
                            headers: this.getHeaders(),
                            body: JSON.stringify({
                                message: message,
                                content: btoa(unescape(encodeURIComponent(content))),
                                sha: sha
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(`æ–‡ä»¶æ“ä½œå¤±è´¥: ${response.status} - ${error.message}`);
                        }

                        return await response.json();
                    } catch (error) {
                        console.error(`æ–‡ä»¶æ“ä½œå‡ºé”™ (${path}):`, error);
                        throw error;
                    }
                }

                // è·å–æ–‡ä»¶å†…å®¹
                async getFile(path) {
                    try {
                        const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repoName}/contents/${path}`, {
                            headers: this.getHeaders()
                        });

                        if (!response.ok) {
                            if (response.status === 404) {
                                return null;
                            }
                            throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${response.status}`);
                        }

                        const data = await response.json();
                        return {
                            content: decodeURIComponent(escape(atob(data.content))),
                            sha: data.sha
                        };
                    } catch (error) {
                        console.error(`è·å–æ–‡ä»¶æ—¶å‡ºé”™ (${path}):`, error);
                        throw error;
                    }
                }

                // è·å–æ•…äº‹åˆ—è¡¨
                async getStoriesList() {
                    try {
                        const fileData = await this.getFile('stories.json');
                        if (!fileData) {
                            return [];
                        }
                        return JSON.parse(fileData.content);
                    } catch (error) {
                        console.error('è·å–æ•…äº‹åˆ—è¡¨å¤±è´¥:', error);
                        throw error;
                    }
                }

                // ä¿å­˜æ•…äº‹æ–‡ä»¶
                async saveStory(title, subtitle, content) {
                    try {
                        const timestamp = Date.now();
                        const fileName = `ai_generated_story_${timestamp}.md`;
                        const markdownContent = `# ${title}\n\n${subtitle}\n\n${content}`;
                        const path = `story/${fileName}`;

                        await this.createOrUpdateFile(path, markdownContent, `æ·»åŠ æ•…äº‹: ${title}`);

                        // æ›´æ–°stories.json
                        const stories = await this.getStoriesList();
                        stories.push({
                            title: title,
                            file: fileName
                        });
                        await this.createOrUpdateFile('stories.json', JSON.stringify(stories, null, 2), `æ›´æ–°æ•…äº‹åˆ—è¡¨: æ·»åŠ  ${title}`);

                        return {
                            fileName: fileName,
                            path: path
                        };
                    } catch (error) {
                        console.error('ä¿å­˜æ•…äº‹å¤±è´¥:', error);
                        throw error;
                    }
                }
            }

            // æ¨¡æ€æ¡†æ§åˆ¶
            function showModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function hideModal(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            // Toast é€šçŸ¥å‡½æ•°
            function showToast(message, type = 'success', duration = 5000) {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
                const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';

                toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out max-w-sm`;
                toast.style.transform = 'translateX(100%)';
                toast.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${icon}</span>
                        <div class="flex-1">
                            <p class="font-medium">${message}</p>
                        </div>
                        <button class="text-white hover:text-gray-200 transition-colors" onclick="this.parentElement.parentElement.remove()">
                            &times;
                        </button>
                    </div>
                `;

                toastContainer.appendChild(toast);

                // åŠ¨ç”»æ˜¾ç¤º
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                }, 100);

                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);

                return toast;
            }

            // åŠ è½½å·²ä¿å­˜çš„ API é…ç½®
            const savedConfig = loadApiConfig();
            if (savedConfig) {
                apiBaseurlInput.value = savedConfig.baseurl || '';
                apiKeyInput.value = savedConfig.apikey || '';
            }

            async function initialize() {
                try {
                    // æ¸…ç©ºæ•…äº‹åˆ—è¡¨ï¼Œé˜²æ­¢é‡å¤
                    storyListElement.innerHTML = '';

                    // ä¼˜å…ˆä» GitHub åŠ è½½æ•…äº‹åˆ—è¡¨
                    let stories = [];
                    let useGitHub = false;

                    const githubConfig = GitHubAPI.loadToken();
                    if (githubConfig) {
                        try {
                            const githubAPI = new GitHubAPI(githubConfig.token, githubConfig.username);
                            stories = await githubAPI.getStoriesList();
                            if (stories && stories.length > 0) {
                                useGitHub = true;
                                console.log('ä» GitHub åŠ è½½æ•…äº‹åˆ—è¡¨æˆåŠŸ');
                            }
                        } catch (error) {
                            console.warn('ä» GitHub åŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°æ–‡ä»¶:', error);
                        }
                    }

                    // å¦‚æœ GitHub åŠ è½½å¤±è´¥æˆ–æ²¡æœ‰æ•°æ®ï¼Œé™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                    if (!useGitHub) {
                        console.log('å°è¯•ä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ•…äº‹åˆ—è¡¨');
                        const response = await fetch('stories.json');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        stories = await response.json();
                        console.log('ä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ•…äº‹åˆ—è¡¨æˆåŠŸ');
                    }

                    stories.forEach(story => {
                        const listItem = document.createElement('li');
                        const isCloud = useGitHub && story.file && story.file.startsWith('ai_generated_story_');
                        const cloudIcon = isCloud ? ' â˜ï¸' : '';
                        listItem.innerHTML = `<a href="#" class="block p-4 story-list-item" data-story-file="${story.file}">${story.title}${cloudIcon}</a>`;
                        storyListElement.appendChild(listItem);
                    });

                    // å¦‚æœæ²¡æœ‰æ•…äº‹ï¼Œæ˜¾ç¤ºæç¤º
                    if (stories.length === 0) {
                        const placeholderItem = document.createElement('li');
                        placeholderItem.innerHTML = `<div class="p-4 text-center text-gray-500 italic">æš‚æ— æ•…äº‹ï¼Œè¯·ç”Ÿæˆæ–°æ•…äº‹</div>`;
                        storyListElement.appendChild(placeholderItem);
                    }

                    storyListElement.addEventListener('click', (event) => {
                        event.preventDefault();
                        const target = event.target.closest('.story-list-item');

                        if (target) {
                            document.querySelectorAll('.story-list-item').forEach(item => item.classList.remove('active'));
                            target.classList.add('active');
                            const storyFile = target.dataset.storyFile;
                            loadStory(storyFile, useGitHub);
                        }
                    });

                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    const placeholderItem = document.createElement('li');
                    placeholderItem.innerHTML = `<div class="p-4 text-center text-gray-500 italic">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•…äº‹æ¥é˜…è¯»</div>`;
                    storyListElement.appendChild(placeholderItem);

                    // æ˜¾ç¤ºæ•°æ®æºæç¤º
                    if (useGitHub) {
                        console.log('âœ… ä½¿ç”¨ GitHub äº‘ç«¯æ•…äº‹åˆ—è¡¨');
                    } else {
                        console.log('â„¹ï¸ ä½¿ç”¨æœ¬åœ°æ•…äº‹åˆ—è¡¨ï¼ˆé™çº§æ¨¡å¼ï¼‰');
                    }

                } catch (error) {
                    console.error('æ— æ³•åŠ è½½æ•…äº‹åˆ—è¡¨:', error);
                    storyListElement.innerHTML = `<li class="text-red-600 p-4">åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥ï¼š${error.message}</li>`;
                }
            }

            async function loadStory(fileName, useGitHub = false) {
                storyContentElement.style.opacity = 0;

                // Show loading indicator after a short delay
                const loadingTimeout = setTimeout(() => {
                    const sourceText = useGitHub ? 'ä»äº‘ç«¯åŠ è½½æ•…äº‹...' : 'æ­£åœ¨åŠ è½½æ•…äº‹...';
                    storyContentElement.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-xl text-stone-500 animate-pulse">${sourceText}</p></div>`;
                    storyContentElement.style.opacity = 1;
                }, 200);

                try {
                    let markdownContent = '';

                    if (useGitHub) {
                        // ä» GitHub åŠ è½½æ•…äº‹
                        const githubConfig = GitHubAPI.loadToken();
                        if (githubConfig) {
                            try {
                                const githubAPI = new GitHubAPI(githubConfig.token, githubConfig.username);
                                const fileData = await githubAPI.getFile(`story/${fileName}`);
                                if (fileData) {
                                    markdownContent = fileData.content;
                                } else {
                                    throw new Error('æ•…äº‹æ–‡ä»¶ä¸å­˜åœ¨');
                                }
                            } catch (error) {
                                console.warn('ä» GitHub åŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°æ–‡ä»¶:', error);
                                // é™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                                const response = await fetch(`story/${fileName}`);
                                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                                markdownContent = await response.text();
                            }
                        } else {
                            // æ²¡æœ‰ GitHub é…ç½®ï¼Œé™çº§åˆ°æœ¬åœ°æ–‡ä»¶
                            const response = await fetch(`story/${fileName}`);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            markdownContent = await response.text();
                        }
                    } else {
                        // ä»æœ¬åœ°åŠ è½½æ•…äº‹
                        const response = await fetch(`story/${fileName}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        markdownContent = await response.text();
                    }

                    // æå–ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜ï¼Œç¬¬äºŒè¡Œä¸ºå‰¯æ ‡é¢˜
                    const lines = markdownContent.split('\n');
                    const title = lines[0].replace(/^#\s*/, '');
                    const subtitle = lines[1];
                    const body = lines.slice(2).join('\n');

                    clearTimeout(loadingTimeout);

                    setTimeout(() => {
                        const cloudBadge = useGitHub ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">â˜ï¸ äº‘ç«¯æ•…äº‹</span>' : '';
                        const storyHTML = `
                            <header class="story-header">
                                <div class="flex items-center justify-between">
                                    <h1 class="story-title">${title}</h1>
                                    ${cloudBadge}
                                </div>
                                <p class="story-subtitle">${subtitle}</p>
                            </header>
                            <main>
                                <div class="story-body">${marked.parse(body)}</div>
                            </main>
                        `;
                        storyContentElement.innerHTML = storyHTML;
                        storyContentElement.style.opacity = 1;
                    }, 50);

                } catch (error) {
                    clearTimeout(loadingTimeout);
                    console.error('åŠ è½½æ•…äº‹æ—¶å‡ºé”™:', error);
                    storyContentElement.innerHTML = `<div class="text-red-600">åŠ è½½æ•…äº‹å¤±è´¥ï¼š${error.message}<br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</small></div>`;
                    storyContentElement.style.opacity = 1;
                }
            }

            initialize();

            // æç¤ºè¯æ¨¡æ¿ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.prompt-template').forEach(button => {
                button.addEventListener('click', () => {
                    const prompt = button.getAttribute('data-prompt');
                    storyPromptInput.value = prompt;
                    storyPromptInput.focus();
                });
            });

            // ============ AI åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ ============

            // AI ç”ŸæˆæŒ‰é’®ç‚¹å‡»
            aiGenerateBtn.addEventListener('click', async () => {
                const config = loadApiConfig();
                if (!config || !config.baseurl || !config.apikey) {
                    showModal(aiSettingsModal);
                } else {
                    // æ‰“å¼€æ¨¡æ€æ¡†å‰å…ˆåˆ·æ–°æ¨¡å‹åˆ—è¡¨å¹¶æ¢å¤é€‰æ‹©
                    try {
                        modelSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                        const models = await fetchModels();

                        if (models.length === 0) {
                            modelSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                        } else {
                            modelSelect.innerHTML = '';
                            models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.id;
                                modelSelect.appendChild(option);
                            });
                            // æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ¨¡å‹
                            restoreSelectedModel();
                        }
                    } catch (error) {
                        console.warn('åˆ·æ–°æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    }
                    showModal(aiGenerateModal);
                }
            });

            // è®¾ç½®æ¨¡æ€æ¡†æ§åˆ¶
            closeSettingsBtn.addEventListener('click', () => hideModal(aiSettingsModal));
            aiSettingsModal.addEventListener('click', (e) => {
                if (e.target === aiSettingsModal) hideModal(aiSettingsModal);
            });

            // ============ GitHub äº‘å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨ ============

            // GitHub è®¾ç½®æŒ‰é’®ç‚¹å‡»
            githubSettingsBtn.addEventListener('click', () => {
                const savedConfig = GitHubAPI.loadToken();
                if (savedConfig) {
                    githubUsernameInput.value = savedConfig.username || 'geliya23';
                    githubTokenInput.value = savedConfig.token || '';
                }
                showModal(githubSettingsModal);
            });

            // GitHub è®¾ç½®æ¨¡æ€æ¡†æ§åˆ¶
            closeGithubSettingsBtn.addEventListener('click', () => hideModal(githubSettingsModal));
            githubSettingsModal.addEventListener('click', (e) => {
                if (e.target === githubSettingsModal) hideModal(githubSettingsModal);
            });

            // ä¿å­˜ GitHub è®¾ç½®
            saveGithubSettingsBtn.addEventListener('click', async () => {
                const username = githubUsernameInput.value.trim();
                const token = githubTokenInput.value.trim();

                if (!username || !token) {
                    showToast('è¯·å¡«å†™å®Œæ•´çš„ GitHub ä¿¡æ¯', 'warning');
                    return;
                }

                githubStatusDiv.classList.remove('hidden');
                githubStatusDiv.innerHTML = '<p class="text-blue-600">æ­£åœ¨éªŒè¯ Token...</p>';

                try {
                    // åˆ›å»º GitHubAPI å®ä¾‹è¿›è¡ŒéªŒè¯
                    const githubAPI = new GitHubAPI(token, username);
                    const isValid = await githubAPI.validateToken();

                    if (!isValid) {
                        githubStatusDiv.innerHTML = '<p class="text-red-600">âŒ Token æ— æ•ˆæˆ–å·²è¿‡æœŸ</p>';
                        showToast('Token éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®', 'error');
                        return;
                    }

                    // éªŒè¯é€šè¿‡ï¼Œä¿å­˜è®¾ç½®
                    githubAPI.saveToken(token);
                    githubStatusDiv.innerHTML = '<p class="text-green-600">âœ… Token éªŒè¯æˆåŠŸ</p>';

                    // æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
                    githubStatusDiv.innerHTML = '<p class="text-blue-600">æ­£åœ¨æ£€æŸ¥ä»“åº“...</p>';
                    const repoExists = await githubAPI.checkRepository();

                    if (!repoExists) {
                        githubStatusDiv.innerHTML = '<p class="text-blue-600">ä»“åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...</p>';
                        try {
                            await githubAPI.createRepository();
                            await githubAPI.initializeRepository();
                            githubStatusDiv.innerHTML = '<p class="text-green-600">âœ… ä»“åº“åˆ›å»ºæˆåŠŸï¼</p>';
                            showToast('GitHub äº‘å­˜å‚¨é…ç½®æˆåŠŸï¼', 'success');
                        } catch (createError) {
                            githubStatusDiv.innerHTML = `<p class="text-red-600">âŒ åˆ›å»ºä»“åº“å¤±è´¥: ${createError.message}</p>`;
                            showToast(`åˆ›å»ºä»“åº“å¤±è´¥: ${createError.message}`, 'error');
                        }
                    } else {
                        githubStatusDiv.innerHTML = '<p class="text-green-600">âœ… ä»“åº“å·²å­˜åœ¨</p>';
                        showToast('GitHub äº‘å­˜å‚¨é…ç½®æˆåŠŸï¼', 'success');
                    }

                    // å»¶è¿Ÿå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        hideModal(githubSettingsModal);
                    }, 2000);

                } catch (error) {
                    console.error('GitHub é…ç½®å¤±è´¥:', error);
                    githubStatusDiv.innerHTML = `<p class="text-red-600">âŒ é…ç½®å¤±è´¥: ${error.message}</p>`;
                    showToast(`GitHub é…ç½®å¤±è´¥: ${error.message}`, 'error');
                }
            });

            // æ¸…é™¤ GitHub è®¾ç½®
            clearGithubSettingsBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…é™¤ GitHub é…ç½®å—ï¼Ÿ')) {
                    GitHubAPI.clearToken();
                    githubUsernameInput.value = '';
                    githubTokenInput.value = '';
                    githubStatusDiv.classList.add('hidden');
                    githubStatusDiv.innerHTML = '';
                    showToast('GitHub é…ç½®å·²æ¸…é™¤', 'info');
                }
            });

            // ä¿å­˜ API é…ç½®
            saveSettingsBtn.addEventListener('click', () => {
                const baseurl = apiBaseurlInput.value.trim();
                const apikey = apiKeyInput.value.trim();

                if (!baseurl || !apikey) {
                    alert('è¯·å¡«å†™å®Œæ•´çš„ API ä¿¡æ¯');
                    return;
                }

                saveApiConfig(baseurl, apikey);
                hideModal(aiSettingsModal);
                showModal(aiGenerateModal);
            });

            // æ¸…é™¤é…ç½®
            clearSettingsBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…é™¤ API é…ç½®å—ï¼Ÿ')) {
                    clearApiConfig();
                }
            });

            // ç”Ÿæˆæ•…äº‹æ¨¡æ€æ¡†æ§åˆ¶
            closeGenerateBtn.addEventListener('click', () => hideModal(aiGenerateModal));
            cancelBtn.addEventListener('click', () => hideModal(aiGenerateModal));
            aiGenerateModal.addEventListener('click', (e) => {
                if (e.target === aiGenerateModal) hideModal(aiGenerateModal);
            });

            // ============ API è°ƒç”¨å‡½æ•° ============

            // è·å–æ¨¡å‹åˆ—è¡¨
            async function fetchModels() {
                const config = loadApiConfig();
                if (!config) {
                    alert('è¯·å…ˆé…ç½® API');
                    return;
                }

                try {
                    const response = await fetch(`${config.baseurl}/v1/models`, {
                        headers: {
                            'Authorization': `Bearer ${config.apikey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.data || [];
                } catch (error) {
                    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    throw error;
                }
            }

            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            refreshModelsBtn.addEventListener('click', async () => {
                try {
                    modelSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                    const models = await fetchModels();

                    if (models.length === 0) {
                        modelSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                        return;
                    }

                    modelSelect.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        modelSelect.appendChild(option);
                    });

                    // æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ¨¡å‹
                    restoreSelectedModel();
                } catch (error) {
                    modelSelect.innerHTML = '<option value="">è·å–å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</option>';
                    alert('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
                }
            });

            // æ¨¡å‹é€‰æ‹©æ”¹å˜æ—¶ä¿å­˜é€‰æ‹©
            modelSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    saveSelectedModel(e.target.value);
                }
            });

            // ç”Ÿæˆæ•…äº‹
            generateBtn.addEventListener('click', async () => {
                const prompt = storyPromptInput.value.trim();
                const model = modelSelect.value;

                if (!prompt) {
                    alert('è¯·è¾“å…¥æ•…äº‹æç¤ºè¯');
                    return;
                }

                if (!model) {
                    alert('è¯·é€‰æ‹©æ¨¡å‹');
                    return;
                }

                try {
                    generateBtn.disabled = true;
                    generationStatus.classList.remove('hidden');
                    storyResultTextarea.value = '';

                    const config = loadApiConfig();
                    const response = await fetch(`${config.baseurl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apikey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä¸ªå„¿ç«¥æ•…äº‹ä½œå®¶ã€‚è¯·ç”Ÿæˆä¸€ä¸ªç«¥è¯æ•…äº‹ï¼Œéµå¾ªä»¥ä¸‹æ ¼å¼ï¼š\nç¬¬ä¸€è¡Œæ˜¯æ•…äº‹æ ‡é¢˜ï¼ˆä»¥#å¼€å¤´ï¼‰\nç¬¬äºŒè¡Œæ˜¯å‰¯æ ‡é¢˜ï¼ˆä¸€å¥è¯æ¦‚æ‹¬æ•…äº‹ï¼‰\nç¬¬ä¸‰è¡Œå¼€å§‹æ˜¯æ•…äº‹æ­£æ–‡ï¼ˆè‡³å°‘500å­—ï¼ŒåŒ…å«æƒ…èŠ‚å‘å±•ã€é«˜æ½®å’Œç»“å±€ï¼‰'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`ç”Ÿæˆå¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    const story = data.choices[0].message.content;
                    storyResultTextarea.value = story;

                } catch (error) {
                    console.error('ç”Ÿæˆæ•…äº‹å¤±è´¥:', error);
                    alert('ç”Ÿæˆæ•…äº‹å¤±è´¥: ' + error.message);
                } finally {
                    generateBtn.disabled = false;
                    generationStatus.classList.add('hidden');
                }
            });

            // ============ æ•…äº‹ä¿å­˜åŠŸèƒ½ ============

            // ä¿å­˜ç”Ÿæˆçš„æ•…äº‹
            saveStoryBtn.addEventListener('click', async () => {
                const storyContent = storyResultTextarea.value.trim();

                if (!storyContent) {
                    alert('æ²¡æœ‰å¯ä¿å­˜çš„æ•…äº‹å†…å®¹');
                    return;
                }

                // æå–æ ‡é¢˜å’Œå†…å®¹
                const lines = storyContent.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    alert('æ•…äº‹æ ¼å¼ä¸æ­£ç¡®');
                    return;
                }

                const title = lines[0].replace(/^#\s*/, '');
                const subtitle = lines[1];
                const body = lines.slice(2).join('\n');

                if (!title || !subtitle || !body) {
                    alert('æ•…äº‹å¿…é¡»åŒ…å«æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œæ­£æ–‡');
                    return;
                }

                // æ£€æŸ¥ GitHub é…ç½®
                const githubConfig = GitHubAPI.loadToken();
                if (!githubConfig) {
                    showToast('è¯·å…ˆé…ç½® GitHub äº‘å­˜å‚¨è®¾ç½®', 'warning');
                    showModal(githubSettingsModal);
                    return;
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const originalButtonText = saveStoryBtn.textContent;
                saveStoryBtn.disabled = true;
                saveStoryBtn.textContent = 'æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...';

                try {
                    // åˆ›å»º GitHub API å®ä¾‹
                    const githubAPI = new GitHubAPI(githubConfig.token, githubConfig.username);

                    // ä¿å­˜æ•…äº‹åˆ° GitHub
                    const result = await githubAPI.saveStory(title, subtitle, body);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const pagesUrl = `https://${githubConfig.username}.github.io/${githubAPI.repoName}/`;
                    showToast(`æ•…äº‹å·²æˆåŠŸä¿å­˜åˆ° GitHub äº‘ç«¯ï¼`, 'success');

                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯çš„é€šçŸ¥ï¼ˆæ›´é•¿çš„æŒç»­æ—¶é—´ï¼‰
                    setTimeout(() => {
                        showToast(`æ–‡ä»¶: ${result.fileName}`, 'info', 8000);
                    }, 500);

                    setTimeout(() => {
                        showToast(`30ç§’åå¯åœ¨ GitHub Pages æŸ¥çœ‹`, 'info', 8000);
                    }, 1000);

                    // å…³é—­æ¨¡æ€æ¡†
                    hideModal(aiGenerateModal);

                    // æ¸…ç©ºè¡¨å•
                    storyPromptInput.value = '';
                    storyResultTextarea.value = '';

                    // é‡æ–°åŠ è½½æ•…äº‹åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°æ•…äº‹
                    await initialize();

                } catch (error) {
                    console.error('ä¿å­˜æ•…äº‹å¤±è´¥:', error);
                    showToast(`ä¿å­˜æ•…äº‹å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    saveStoryBtn.disabled = false;
                    saveStoryBtn.textContent = originalButtonText;
                }
            });

        });
    </script>
</body>
</html>
