## 上下文
当前童话故事网站是一个纯静态单页应用，仅支持阅读预置故事。需要添加 AI 生成故事功能，让用户能够通过 OpenAI 兼容 API 创建自定义故事。

## 目标 / 非目标
- 目标：
  - 支持多种 OpenAI 兼容 API 提供商
  - 提供直观的用户界面配置 API
  - 集成到现有故事系统中
  - 保持静态网站架构（无服务端）
- 非目标：
  - 不实现后端 API 代理
  - 不提供用户认证系统
  - 不实现云端故事存储

## 技术决策

### API 集成方式
- **决策**：使用客户端 fetch 直接调用 OpenAI 兼容 API
- **理由**：
  - 保持纯静态网站架构
  - 无需服务器部署
  - 减少基础设施复杂度
- **权衡**：
  - 受 CORS 策略限制
  - API 密钥暴露在客户端

### 多提供商支持
- **决策**：抽象化 OpenAI 兼容接口，适配不同提供商
- **支持的提供商**：
  - OpenAI (api.openai.com)
  - Azure OpenAI
  - OpenRouter (openrouter.ai)
  - Ollama (本地部署)
  - 其他兼容 OpenAI API 的提供商
- **实现方式**：统一 baseurl 配置，支持自定义端点

### 模型列表获取
- **决策**：动态调用 /models 端点获取模型
- **API 格式**：
  ```
  GET {baseurl}/v1/models
  Authorization: Bearer {apikey}
  ```
- **处理方式**：
  - 提取模型列表
  - 过滤有效模型（移除不支持的模型）
  - 缓存模型列表（会话期间）

### 故事生成 API
- **决策**：使用 Chat Completions API
- **API 格式**：
  ```
  POST {baseurl}/v1/chat/completions
  Authorization: Bearer {apikey}
  Content-Type: application/json

  {
    "model": "模型名称",
    "messages": [
      {"role": "system", "content": "系统提示"},
      {"role": "user", "content": "用户提示词"}
    ],
    "stream": true
  }
  ```

### 流式响应处理
- **决策**：优先支持流式响应以提升体验
- **实现**：
  - 使用 fetch 读取流数据
  - 解析 Server-Sent Events (SSE)
  - 实时更新 UI 显示部分内容
- **回退**：不支持流式时使用一次性响应

### 数据存储
- **决策**：使用 localStorage 存储 API 配置
- **存储内容**：
  ```javascript
  {
    baseurl: "API 基础 URL",
    apikey: "API 密钥",
    lastModel: "上次使用的模型"
  }
  ```
- **安全考虑**：
  - 纯前端存储，无服务端传输
  - 明文存储（提醒用户安全风险）
  - 提供一键清除功能

### 故事文件格式
- **决策**：遵循现有 Markdown 格式
- **格式要求**：
  ```
  # 故事标题
  副标题描述

  故事正文内容...
  ```
- **生成策略**：
  - 系统提示模型生成符合格式的故事
  - 客户端解析响应并格式化
  - 允许用户编辑后再保存

### UI 设计决策
- **设置面板**：模态框形式，避免页面跳转
- **生成对话框**：三段式布局（提示词输入、模型选择、结果预览）
- **进度指示**：
  - 加载动画：API 调用期间
  - 进度条：流式生成时
  - 状态文本：显示当前操作
- **错误处理**：明确的错误信息和重试选项

## 风险 / 权衡

### CORS 限制
- **风险**：许多 API 提供商不允许浏览器直接调用
- **缓解措施**：
  - 推荐用户使用支持 CORS 的提供商（如 OpenRouter）
  - 提供代理服务器配置说明
  - 文档中明确说明限制

### API 密钥安全
- **风险**：密钥存储在浏览器本地可能被窃取
- **缓解措施**：
  - 仅用于个人使用场景
  - 建议使用最小权限 API 密钥
  - 定期轮换密钥
  - 提供清除功能

### 用户体验复杂性
- **风险**：功能复杂度增加学习成本
- **缓解措施**：
  - 提供默认配置模板
  - 添加帮助说明
  - 简化操作流程
  - 提示词模板辅助

## 迁移计划

### 阶段 1：基础功能
1. 实现 API 配置界面
2. 添加模型列表获取
3. 实现基本故事生成

### 阶段 2：增强体验
1. 添加流式响应支持
2. 实现故事保存功能
3. 优化错误处理

### 阶段 3：完善功能
1. 添加提示词模板
2. 实现故事编辑功能
3. 完善文档和帮助

## 开放问题
- 是否支持自定义系统提示词？
- 是否需要故事长度限制选项？
- 是否需要多轮对话生成？
- 如何处理敏感内容过滤？
